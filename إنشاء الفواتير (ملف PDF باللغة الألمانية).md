# إنشاء الفواتير (ملف PDF باللغة الألمانية)

## مقدمة

تعتبر الفواتير الاحترافية والدقيقة باللغة الألمانية جوهر هذا التطبيق. في هذا القسم، سنركز على تصميم وتوليد فواتير PDF التي لا تلبي المتطلبات الجمالية فحسب، بل تلتزم أيضًا بالمعايير القانونية الألمانية الصارمة. سنقوم بتحديد تخطيط فاتورة افتراضي، وتوفير خيارات للقوالب القابلة للتبديل، وعرض كيفية إنشاء ملفات PDF من خلال الكود، مع دعم التحرير قبل الانتهاء من الفاتورة.

## تخطيط الفاتورة الافتراضي الاحترافي

لضمان مظهر احترافي ومتسق، سنقوم بتصميم تخطيط فاتورة افتراضي يراعي أفضل ممارسات التصميم ويسهل قراءته. سيشمل هذا التخطيط العناصر التالية:

### 1. التسلسل الهرمي للطباعة (Typography Hierarchy)

*   **العنوان الرئيسي (Rechnung):** كبير وواضح، عادةً في الجزء العلوي من الصفحة.
*   **عناوين الأقسام (مثل Rechnungsdaten, Kundendaten, Positionen):** أصغر من العنوان الرئيسي ولكنها مميزة لتقسيم المحتوى.
*   **نص الجسم (Body Text):** حجم خط قياسي لسهولة القراءة، مع تباعد مناسب بين الأسطر.
*   **الخطوط:** استخدام خطوط احترافية وسهلة القراءة (مثل Open Sans, Roboto, Lato) لضمان الوضوح عبر الأجهزة والطباعة.

### 2. التباعد والتخطيط (Spacing and Layout)

*   **الهوامش (Margins):** هوامش واسعة بما يكفي لإعطاء الفاتورة مظهرًا نظيفًا ومنظمًا.
*   **التباعد بين العناصر (Element Spacing):** تباعد متسق بين الكتل النصية، الجداول، والشعارات لتحسين قابلية القراءة.
*   **التخطيط الشبكي (Grid Layout):** استخدام نظام شبكي لترتيب العناصر بشكل متناسق، مما يضمن محاذاة دقيقة.

### 3. تخطيط الجدول (Table Layout)

*   **جدول بنود الفاتورة (Positionstabelle):** هو الجزء الأكثر أهمية في الفاتورة. يجب أن يكون واضحًا ومنظمًا بشكل جيد.
    *   **الأعمدة:** `Artikel` (المنتج/الوصف), `Menge` (الكمية), `Einzelpreis` (سعر الوحدة), `MwSt.` (ضريبة القيمة المضافة), `Gesamt Netto` (الإجمالي الصافي), `Gesamt Brutto` (الإجمالي الإجمالي).
    *   **التنسيق:** محاذاة الأرقام إلى اليمين، والنصوص إلى اليسار. خطوط فاصلة خفيفة بين الصفوف والأعمدة لتحسين الوضوح.
    *   **الإجماليات:** يجب أن تكون الإجماليات الفرعية والضرائب والإجمالي الكلي واضحة ومميزة في نهاية الجدول.

### 4. الشعار والعلامة التجارية (Logo/Branding)

*   **الموضع:** عادةً في الزاوية العلوية اليسرى أو اليمنى من الفاتورة.
*   **الحجم:** حجم مناسب لا يطغى على المحتوى ولكنه مرئي بوضوح.
*   **الألوان:** استخدام ألوان محايدة (مثل الأبيض، الرمادي، الأسود) كلون أساسي، مع إمكانية استخدام لون العلامة التجارية كلون ثانوي للتمييز.

### 5. الألوان (Farben)

*   **لوحة الألوان:** يفضل استخدام لوحة ألوان محايدة ومهنية (مثل تدرجات الرمادي، الأزرق الداكن، الأخضر الداكن) لضمان مظهر أنيق وغير مشتت.
*   **ألوان التمييز:** يمكن استخدام لون واحد أو اثنين من ألوان العلامة التجارية كنقاط تمييز للعناوين أو الأزرار، ولكن باعتدال.

## قوالب ألمانية قابلة للتبديل (Classic/Minimal)

سيوفر التطبيق خيارين لقوالب الفواتير لتلبية التفضيلات المختلفة، مع إمكانية تخصيص العلامة التجارية:

1.  **القالب الكلاسيكي (Classic):** تصميم تقليدي، رسمي، مع تفاصيل كاملة وتخطيط منظم.
2.  **القالب البسيط (Minimal):** تصميم نظيف، حديث، يركز على الأساسيات مع مساحات بيضاء كبيرة.

### تخصيص العلامة التجارية (Switchable Branding)

ستكون العناصر التالية قابلة للتخصيص لكل قالب:

*   **الشعار (Logo):** يمكن للمستخدمين تحميل شعارهم الخاص.
*   **الألوان (Farben):** اختيار لون أساسي ولون ثانوي يتناسب مع العلامة التجارية.
*   **تذييل الصفحة (Fußzeile):** محتوى مخصص في تذييل الصفحة (مثل معلومات الاتصال، تفاصيل البنك، معلومات قانونية).
*   **الشروط والأحكام/البصمة القانونية (AGB/Impressum):** يمكن تضمين نصوص قانونية محددة في الفاتورة أو ربطها بصفحة منفصلة.

## توليد PDF باستخدام الكود (Playwright for HTML->PDF)

سنستخدم Playwright لتحويل محتوى HTML/CSS إلى ملفات PDF. يوفر هذا النهج مرونة كبيرة في التصميم، حيث يمكننا استخدام تقنيات الويب القياسية (HTML, CSS) لتصميم الفواتير، ثم تحويلها بدقة إلى PDF. هذا يسمح أيضًا بإعادة استخدام مكونات الواجهة الأمامية لتصميم الفواتير.

### خطوات توليد PDF:

1.  **إنشاء محتوى HTML:** يتم تجميع بيانات الفاتورة في قالب HTML. هذا القالب سيستخدم Tailwind CSS (أو أي CSS آخر) لتطبيق التنسيقات.
2.  **تشغيل متصفح بدون واجهة رسومية (Headless Browser):** يتم تشغيل Playwright في وضع headless (بدون واجهة رسومية).
3.  **تحميل محتوى HTML:** يتم تحميل محتوى HTML الذي تم إنشاؤه في صفحة المتصفح.
4.  **توليد PDF:** يتم استخدام وظيفة `page.pdf()` في Playwright لإنشاء ملف PDF.

### مثال على الكود (Node.js مع Playwright)

```typescript
// src/services/invoice-pdf.service.ts
import playwright from 'playwright';
import { Invoice, Customer, Organization, InvoiceItem, TaxRate } from '@prisma/client';
import { renderInvoiceHtml } from './invoice-html-renderer.service'; // سنقوم بإنشاء هذا لاحقًا

export class InvoicePdfService {
  async generatePdf(invoice: Invoice & { customer: Customer; organization: Organization; items: (InvoiceItem & { taxRate: TaxRate })[] }): Promise<Buffer> {
    const browser = await playwright.chromium.launch();
    const page = await browser.newPage();

    // Render HTML content for the invoice
    const htmlContent = renderInvoiceHtml(invoice); // This function will generate the HTML string

    // Set the HTML content to the page
    await page.setContent(htmlContent, { waitUntil: 'networkidle' });

    // Generate PDF
    const pdfBuffer = await page.pdf({
      format: 'A4',
      printBackground: true,
      margin: {
        top: '20mm',
        right: '20mm',
        bottom: '20mm',
        left: '20mm',
      },
    });

    await browser.close();
    return pdfBuffer;
  }
}

// src/services/invoice-html-renderer.service.ts
import { Invoice, Customer, Organization, InvoiceItem, TaxRate } from '@prisma/client';

export function renderInvoiceHtml(invoice: Invoice & { customer: Customer; organization: Organization; items: (InvoiceItem & { taxRate: TaxRate })[] }): string {
  const { customer, organization, items } = invoice;

  // Helper function to format currency
  const formatCurrency = (amount: number | string) => {
    return new Intl.NumberFormat('de-DE', { style: 'currency', currency: invoice.currency }).format(Number(amount));
  };

  // Helper function to format date
  const formatDate = (date: Date) => {
    return new Intl.DateTimeFormat('de-DE').format(date);
  };

  // Calculate total tax amounts per rate
  const taxSummary = items.reduce((acc, item) => {
    const rate = item.taxRate.rate.toNumber();
    if (!acc[rate]) {
      acc[rate] = { net: 0, tax: 0 };
    }
    acc[rate].net += item.netAmount.toNumber();
    acc[rate].tax += item.taxAmount.toNumber();
    return acc;
  }, {} as Record<number, { net: number; tax: number }>);

  return `
    <!DOCTYPE html>
    <html lang="de">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Rechnung ${invoice.invoiceNumber}</title>
        <style>
            /* Tailwind CSS would be compiled here or linked from a CDN */
            body {
                font-family: 'Open Sans', sans-serif;
                margin: 0;
                padding: 0;
                color: #333;
                font-size: 10pt;
            }
            .container {
                width: 100%;
                max-width: 210mm; /* A4 width */
                margin: 0 auto;
                padding: 20mm;
                box-sizing: border-box;
            }
            .header,
            .footer {
                width: 100%;
                position: fixed;
                left: 0;
                right: 0;
                background-color: #fff;
            }
            .header {
                top: 0;
                padding: 10mm 20mm 0;
                border-bottom: 1px solid #eee;
            }
            .footer {
                bottom: 0;
                padding: 0 20mm 10mm;
                border-top: 1px solid #eee;
                text-align: center;
                font-size: 8pt;
            }
            .invoice-details,
            .customer-details,
            .company-details {
                margin-bottom: 20px;
            }
            .invoice-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 20px;
            }
            .invoice-table th,
            .invoice-table td {
                border: 1px solid #eee;
                padding: 8px;
                text-align: left;
            }
            .invoice-table th {
                background-color: #f9f9f9;
                font-weight: bold;
            }
            .text-right {
                text-align: right;
            }
            .total-summary {
                margin-top: 20px;
                width: 40%;
                float: right;
                border: 1px solid #eee;
                padding: 10px;
            }
            .total-summary div {
                display: flex;
                justify-content: space-between;
                padding: 3px 0;
            }
            .total-summary .grand-total {
                font-weight: bold;
                font-size: 1.1em;
                border-top: 1px solid #eee;
                margin-top: 5px;
                padding-top: 5px;
            }
            .clearfix::after {
                content: "";
                clear: both;
                display: table;
            }
            .logo {
                max-width: 150px;
                height: auto;
                float: right;
            }
            .company-info {
                float: left;
            }
            .invoice-header-info {
                float: right;
                text-align: right;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header clearfix">
                ${organization.logoUrl ? `<img src="${organization.logoUrl}" alt="Company Logo" class="logo">` : ''}
                <div class="company-info">
                    <strong>${organization.name}</strong><br>
                    ${organization.address}<br>
                    ${organization.zipCode} ${organization.city}<br>
                    ${organization.country}<br>
                    ${organization.taxId ? `USt-IdNr.: ${organization.taxId}<br>` : ''}
                </div>
                <div class="invoice-header-info">
                    <h1>RECHNUNG</h1>
                    <p><strong>Rechnungsnummer:</strong> ${invoice.invoiceNumber}</p>
                    <p><strong>Datum:</strong> ${formatDate(invoice.issueDate)}</p>
                    ${invoice.serviceDate ? `<p><strong>Leistungsdatum:</strong> ${formatDate(invoice.serviceDate)}</p>` : ''}
                    <p><strong>Fälligkeitsdatum:</strong> ${formatDate(invoice.dueDate)}</p>
                </div>
            </div>

            <div style="height: 100mm;"></div> <!-- Placeholder for header height -->

            <div class="customer-details">
                <h3>Rechnung an:</h3>
                <strong>${customer.name}</strong><br>
                ${customer.address}<br>
                ${customer.zipCode} ${customer.city}<br>
                ${customer.country}<br>
                ${customer.taxId ? `USt-IdNr.: ${customer.taxId}<br>` : ''}
            </div>

            <table class="invoice-table">
                <thead>
                    <tr>
                        <th>Artikel</th>
                        <th class="text-right">Menge</th>
                        <th class="text-right">Einzelpreis</th>
                        <th class="text-right">MwSt.</th>
                        <th class="text-right">Gesamt Netto</th>
                        <th class="text-right">Gesamt Brutto</th>
                    </tr>
                </thead>
                <tbody>
                    ${items.map(item => `
                        <tr>
                            <td>${item.description}</td>
                            <td class="text-right">${item.quantity.toFixed(2)}</td>
                            <td class="text-right">${formatCurrency(item.unitPrice)}</td>
                            <td class="text-right">${(item.taxRate.rate.toNumber() * 100).toFixed(0)}%</td>
                            <td class="text-right">${formatCurrency(item.netAmount)}</td>
                            <td class="text-right">${formatCurrency(item.grossAmount)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>

            <div class="total-summary clearfix">
                <div><span>Zwischensumme Netto:</span> <span>${formatCurrency(invoice.totalNet)}</span></div>
                ${Object.entries(taxSummary).map(([rate, totals]) => `
                    <div><span>MwSt. ${Number(rate) * 100}% (${formatCurrency(totals.net)} Netto):</span> <span>${formatCurrency(totals.tax)}</span></div>
                `).join('')}
                <div class="grand-total"><span>Gesamtbetrag Brutto:</span> <span>${formatCurrency(invoice.totalGross)}</span></div>
            </div>

            <div style="clear: both; margin-top: 50px;">
                <h3>Zahlungsinformationen:</h3>
                <p>
                    Bitte überweisen Sie den Gesamtbetrag von <strong>${formatCurrency(invoice.totalGross)}</strong> bis zum ${formatDate(invoice.dueDate)} auf folgendes Konto:
                </p>
                <p>
                    <strong>Bank:</strong> ${organization.bankName || 'Ihre Bank'}<br>
                    <strong>IBAN:</strong> ${organization.iban || 'DEXXXXXXXXXXXXXXXXXXXXXX'}<br>
                    <strong>BIC:</strong> ${organization.bic || 'XXXXXXXXXXX'}<br>
                </p>
            </div>

            <div class="footer">
                <p>
                    ${organization.name} | ${organization.address}, ${organization.zipCode} ${organization.city} | USt-IdNr.: ${organization.taxId || 'DEXXXXXXXXX'}
                    <br>
                    ${organization.iban ? `IBAN: ${organization.iban} | BIC: ${organization.bic}` : ''}
                    <br>
                    ${/* Add AGB/Impressum links or text here based on template settings */ ''}
                </p>
            </div>
        </div>
    </body>
    </html>
  `;
}
```

**كيفية تشغيل هذا الكود:**

1.  **تثبيت Playwright:**
    ```bash
    npm install playwright @prisma/client
    npx playwright install chromium
    ```
2.  **إنشاء ملفات الخدمة:** قم بإنشاء الملف `src/services/invoice-pdf.service.ts` و `src/services/invoice-html-renderer.service.ts` وانسخ المحتوى أعلاه.
3.  **مثال على الاستخدام:**
    ```typescript
    // src/app.ts (مثال على نقطة الدخول)
    import { InvoicePdfService } from './services/invoice-pdf.service';
    import { PrismaClient } from '@prisma/client';
    import { writeFileSync } from 'fs';

    const prisma = new PrismaClient();

    async function generateSampleInvoice() {
      // هذا مثال لبيانات فاتورة وهمية. في التطبيق الحقيقي، ستأتي هذه البيانات من قاعدة البيانات.
      const sampleInvoice = await prisma.invoice.findFirst({
        where: { invoiceNumber: '20230001' }, // ابحث عن فاتورة موجودة أو أنشئ واحدة للاختبار
        include: {
          customer: true,
          organization: true,
          items: { include: { taxRate: true } },
        },
      });

      if (!sampleInvoice) {
        console.error('Sample invoice not found. Please create one in the database first.');
        return;
      }

      const pdfService = new InvoicePdfService();
      try {
        const pdfBuffer = await pdfService.generatePdf(sampleInvoice);
        writeFileSync('./sample-invoice.pdf', pdfBuffer);
        console.log('Sample invoice PDF generated successfully: sample-invoice.pdf');
      } catch (error) {
        console.error('Error generating PDF:', error);
      }
    }

    generateSampleInvoice();
    ```

## دعم التحرير قبل الانتهاء (Draft State vs. Finalized)

لضمان المرونة والامتثال، ستدعم الفواتير حالتين رئيسيتين:

1.  **حالة المسودة (Draft State):**
    *   **التحرير الكامل:** يمكن تحرير جميع تفاصيل الفاتورة (البنود، الكميات، الأسعار، العناوين، إلخ).
    *   **عدم قابلية التغيير:** لا يتم تطبيق أي قيود على التغيير في هذه المرحلة.
    *   **التخزين المؤقت:** يتم حفظ المسودات بشكل دوري (autosave) لضمان عدم فقدان البيانات.
    *   **رقم الفاتورة:** قد لا يتم تعيين رقم فاتورة نهائي حتى يتم الانتهاء منها.

2.  **حالة الانتهاء (Finalized State):**
    *   **عدم قابلية التغيير (Immutability):** بمجرد الانتهاء من الفاتورة، تصبح غير قابلة للتغيير. هذا أمر بالغ الأهمية للامتثال القانوني الألماني.
    *   **التجزئة (Immutable Hash):** يتم إنشاء تجزئة (hash) فريدة لمحتوى الفاتورة بالكامل (بما في ذلك جميع البيانات والنص) وتخزينها في حقل `immutableHash` في جدول `Invoice`. يمكن استخدام هذه التجزئة للتحقق من أن الفاتورة لم يتم تعديلها بعد الانتهاء منها.
    *   **سجل التدقيق (Audit Log):** يتم تسجيل حدث الانتهاء من الفاتورة في `AuditLog`، مع ربط `auditLogId` بالفاتورة. يتضمن سجل التدقيق من قام بالانتهاء من الفاتورة ومتى.
    *   **رقم الفاتورة المتسلسل:** يتم تعيين رقم فاتورة متسلسل وفريد للفاتورة عند الانتهاء منها.

### عملية الانتهاء من الفاتورة:

1.  يقوم المستخدم بمراجعة الفاتورة في حالة المسودة.
2.  يضغط المستخدم على زر 


الانتهاء من الفاتورة (Finalize Invoice).
3.  يقوم النظام بالتحقق النهائي من صحة البيانات.
4.  يتم توليد رقم فاتورة متسلسل جديد (إذا لم يكن موجودًا).
5.  يتم توليد ملف PDF النهائي للفاتورة وتخزينه في تخزين S3، ويتم حفظ `pdfUrl`.
6.  يتم حساب تجزئة (hash) لمحتوى الفاتورة بالكامل (بما في ذلك ملف PDF) وتخزينها في `immutableHash`.
7.  يتم إنشاء سجل تدقيق (AuditLog) لعملية الانتهاء من الفاتورة، ويتم ربط `auditLogId` بالفاتورة.
8.  تتغير حالة الفاتورة إلى `SENT` أو `FINALIZED`.

## توليد أسماء ملفات الفواتير وقواعد تسلسل الأرقام

تعد أسماء ملفات الفواتير وأرقامها المتسلسلة أمرًا بالغ الأهمية لكل من التنظيم والامتثال القانوني، خاصة في ألمانيا حيث توجد متطلبات صارمة بشأن أرقام الفواتير المتسلسلة (`fortlaufende Rechnungsnummer`).

### قواعد تسلسل أرقام الفواتير (Configurable Sequencing Rules)

يجب أن يكون نظام ترقيم الفواتير مرنًا وقابلاً للتكوين لكل منظمة. يمكن أن تتضمن القواعد ما يلي:

*   **بادئة (Präfix):** بادئة نصية اختيارية (مثل `INV-`, `RE-`).
*   **السنة (Jahr):** تضمين السنة الحالية (مثل `2023`).
*   **الشهر (Monat):** تضمين الشهر الحالي (مثل `09`).
*   **العداد المتسلسل (Sequential Counter):** عداد رقمي يزيد تلقائيًا لكل فاتورة داخل المنظمة.

**مثال على تنسيق رقم الفاتورة:** `INV-2023-09-0001`, `RE-23-00005`, `20230001`.

**آلية التوليد:**

1.  عند الانتهاء من الفاتورة، يقوم النظام بالبحث عن آخر رقم فاتورة تم استخدامه للمنظمة الحالية.
2.  يزيد العداد المتسلسل ويقوم بتنسيق رقم الفاتورة الجديد بناءً على القواعد المحددة (بادئة، سنة، شهر، عداد).
3.  يتم تخزين هذا الرقم في حقل `invoiceNumber` في جدول `Invoice`.

### توليد أسماء ملفات الفواتير (Invoice Filename Generation)

يجب أن تكون أسماء ملفات PDF للفواتير وصفية وفريدة لسهولة التعرف عليها وتخزينها. يمكن أن يتضمن اسم الملف:

*   **رقم الفاتورة:** العنصر الأكثر أهمية للتعرف على الفاتورة.
*   **اسم العميل:** للمساعدة في تحديد العميل بسرعة.
*   **تاريخ الإصدار:** لتوفير سياق زمني.

**مثال على تنسيق اسم الملف:** `Rechnung_INV-2023-09-0001_Max_Mustermann_2023-09-19.pdf`

## قائمة التحقق ومعايير القبول

*   [ ] **تخطيط فاتورة افتراضي:** تم تحديد تخطيط فاتورة احترافي مع التسلسل الهرمي للطباعة، التباعد، وتخطيط الجدول.
*   [ ] **الشعار والعلامة التجارية:** دعم تضمين شعار المنظمة وخيارات ألوان محايدة.
*   [ ] **قوالب قابلة للتبديل:** توفير قالبين على الأقل (كلاسيكي وبسيط) مع تخصيص العلامة التجارية.
*   [ ] **توليد PDF باستخدام Playwright:** استخدام Playwright لتحويل HTML/CSS إلى PDF لمرونة التصميم.
*   [ ] **محتوى PDF باللغة الألمانية:** جميع النصوص في الفاتورة النهائية باللغة الألمانية، بما في ذلك العناوين، الأوصاف، والمبالغ.
*   [ ] **دعم التحرير (Draft State):** يمكن تحرير الفواتير في حالة المسودة.
*   [ ] **حالة الانتهاء (Finalized State):** الفواتير النهائية غير قابلة للتغيير ويتم إنشاء تجزئة لها.
*   [ ] **سجل التدقيق:** يتم تسجيل عملية الانتهاء من الفاتورة في سجل التدقيق.
*   [ ] **تسلسل أرقام الفواتير:** يتم توليد أرقام فواتير متسلسلة وفريدة لكل منظمة وقابلة للتكوين (بادئة، سنة، شهر، عداد).
*   [ ] **أسماء ملفات الفواتير:** يتم توليد أسماء ملفات PDF وصفية وفريدة.
*   [ ] **المتطلبات القانونية الألمانية:** تلبية جميع المتطلبات القانونية للفواتير الألمانية (رقم فاتورة متسلسل، تاريخ إصدار، تاريخ أداء الخدمة، USt-IdNr.، تفاصيل كاملة للمورد والعميل، إلخ).

بهذا نكون قد أكملنا تفاصيل عملية إنشاء الفواتير، مع التركيز على الجودة، المرونة، والامتثال للمتطلبات الألمانية.

