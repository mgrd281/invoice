# لوحات تحكم المسؤول والمستخدم

## مقدمة

تعتبر لوحات التحكم المصممة بعناية جوهر تجربة المستخدم في أي تطبيق ويب حديث. في هذا القسم، سنقوم بتصميم وتطوير لوحتي تحكم منفصلتين ومتخصصتين: واحدة للمستخدمين النهائيين الذين يديرون فواتيرهم وعملائهم، وأخرى للمسؤولين الذين يشرفون على النظام بأكمله. ستكون جميع واجهات المستخدم باللغة الألمانية، مع التركيز على سهولة الاستخدام، الوضوح، والكفاءة.

## لوحة تحكم المستخدم (User Dashboard)

تهدف لوحة تحكم المستخدم إلى توفير واجهة بديهية وشاملة للمستخدمين النهائيين لإدارة جميع جوانب عملية إنشاء الفواتير. ستتضمن هذه اللوحة عدة أقسام رئيسية، كل منها مصمم لتلبية احتياجات محددة في سير العمل.

### الشاشات الرئيسية للمستخدم

#### 1. شاشة التحميلات (Uploads)

تسمح هذه الشاشة للمستخدمين بتحميل ملفات CSV من Shopify ومراقبة حالة معالجتها. تتضمن الميزات التالية:

*   **منطقة السحب والإفلات (Drag & Drop Zone):** منطقة بصرية واضحة لسحب وإفلات ملفات CSV، مع رسائل توجيهية باللغة الألمانية مثل "CSV-Datei hier ablegen oder klicken zum Auswählen".
*   **شريط التقدم (Progress Bar):** يعرض تقدم تحميل الملف ومعالجته في الوقت الفعلي.
*   **سجل التحميلات (Upload History):** جدول يعرض جميع التحميلات السابقة مع تفاصيل مثل اسم الملف، تاريخ التحميل، الحالة (Ausstehend, Verarbeitung, Abgeschlossen, Fehlgeschlagen)، وعدد الصفوف المعالجة.
*   **تفاصيل الأخطاء (Error Details):** عند فشل المعالجة، يتم عرض تفاصيل الأخطاء بطريقة واضحة ومفيدة للمستخدم.

#### 2. شاشة العملاء (Kunden)

تمكن المستخدمين من إدارة قاعدة بيانات العملاء الخاصة بهم:

*   **قائمة العملاء (Kundenliste):** جدول قابل للبحث والتصفية يعرض جميع العملاء مع معلومات أساسية مثل الاسم، البريد الإلكتروني، المدينة، وتاريخ آخر طلب.
*   **إضافة عميل جديد (Neuen Kunden hinzufügen):** نموذج لإضافة عملاء جدد يدويًا، مع جميع الحقول المطلوبة للفواتير الألمانية.
*   **تحرير بيانات العميل (Kundendaten bearbeiten):** إمكانية تحديث معلومات العملاء الموجودين.
*   **عرض تاريخ العميل (Kundenhistorie):** عرض جميع الطلبات والفواتير المرتبطة بعميل معين.

#### 3. شاشة الطلبات (Aufträge)

تعرض جميع الطلبات المستوردة من Shopify أو المنشأة يدويًا:

*   **قائمة الطلبات (Auftragsliste):** جدول شامل يعرض رقم الطلب، العميل، التاريخ، المبلغ الإجمالي، والحالة.
*   **تصفية وبحث متقدم (Erweiterte Filter):** إمكانية التصفية حسب التاريخ، العميل، الحالة، أو المبلغ.
*   **تفاصيل الطلب (Auftragsdetails):** عرض تفصيلي لكل طلب يتضمن بنود الطلب، معلومات الشحن، والدفع.
*   **إنشاء فاتورة من الطلب (Rechnung aus Auftrag erstellen):** زر سريع لتحويل طلب إلى فاتورة.

#### 4. شاشة الفواتير (Rechnungen)

المحور الرئيسي للتطبيق، حيث يدير المستخدمون فواتيرهم:

*   **قائمة الفواتير (Rechnungsliste):** عرض جميع الفواتير مع معلومات مثل رقم الفاتورة، العميل، تاريخ الإصدار، المبلغ، والحالة (Entwurf, Gesendet, Bezahlt, Überfällig).
*   **إنشاء فاتورة جديدة (Neue Rechnung erstellen):** معالج خطوة بخطوة لإنشاء فاتورة جديدة من الصفر.
*   **معاينة الفاتورة (Rechnungsvorschau):** عرض مسبق للفاتورة قبل الانتهاء منها، مع إمكانية التحرير.
*   **تحميل PDF:** إمكانية تحميل ملف PDF للفواتير المكتملة.
*   **إرسال الفاتورة (Rechnung versenden):** إرسال الفاتورة عبر البريد الإلكتروني مباشرة من التطبيق.

#### 5. شاشة القوالب (Vorlagen)

تسمح للمستخدمين بإدارة قوالب الفواتير:

*   **قائمة القوالب (Vorlagenliste):** عرض جميع القوالب المتاحة (الافتراضية والمخصصة).
*   **معاينة القالب (Vorlagenvorschau):** عرض مسبق لكيفية ظهور الفاتورة بقالب معين.
*   **تخصيص القالب (Vorlage anpassen):** محرر بصري لتخصيص الألوان، الشعار، والتخطيط.
*   **إنشاء قالب جديد (Neue Vorlage erstellen):** إمكانية إنشاء قوالب مخصصة جديدة.

#### 6. شاشة الإعدادات (Einstellungen)

تتيح للمستخدمين تكوين حساباتهم ومنظماتهم:

*   **معلومات الشركة (Firmeninformationen):** تحديث تفاصيل المنظمة مثل الاسم، العنوان، رقم ضريبة القيمة المضافة، ومعلومات البنك.
*   **إعدادات الفواتير (Rechnungseinstellungen):** تكوين تنسيق أرقام الفواتير، شروط الدفع الافتراضية، ومعدلات الضرائب.
*   **تكامل Shopify:** إعداد أو تحديث اتصال Shopify.
*   **إعدادات الحساب (Kontoeinstellungen):** تغيير كلمة المرور، تحديث البريد الإلكتروني، وإدارة تفضيلات الإشعارات.

### هيكل صفحات React/Next.js للمستخدم

```typescript
// src/pages/dashboard/index.tsx - الصفحة الرئيسية للوحة التحكم
import { NextPage } from 'next';
import { DashboardLayout } from '../../components/layouts/DashboardLayout';
import { DashboardOverview } from '../../components/dashboard/DashboardOverview';

const UserDashboard: NextPage = () => {
  return (
    <DashboardLayout title="Dashboard">
      <DashboardOverview />
    </DashboardLayout>
  );
};

export default UserDashboard;

// src/pages/dashboard/uploads.tsx - شاشة التحميلات
import { NextPage } from 'next';
import { DashboardLayout } from '../../components/layouts/DashboardLayout';
import { UploadManager } from '../../components/uploads/UploadManager';

const UploadsPage: NextPage = () => {
  return (
    <DashboardLayout title="CSV-Uploads">
      <UploadManager />
    </DashboardLayout>
  );
};

export default UploadsPage;

// src/pages/dashboard/customers.tsx - شاشة العملاء
import { NextPage } from 'next';
import { DashboardLayout } from '../../components/layouts/DashboardLayout';
import { CustomerManager } from '../../components/customers/CustomerManager';

const CustomersPage: NextPage = () => {
  return (
    <DashboardLayout title="Kunden">
      <CustomerManager />
    </DashboardLayout>
  );
};

export default CustomersPage;

// src/pages/dashboard/orders.tsx - شاشة الطلبات
import { NextPage } from 'next';
import { DashboardLayout } from '../../components/layouts/DashboardLayout';
import { OrderManager } from '../../components/orders/OrderManager';

const OrdersPage: NextPage = () => {
  return (
    <DashboardLayout title="Aufträge">
      <OrderManager />
    </DashboardLayout>
  );
};

export default OrdersPage;

// src/pages/dashboard/invoices.tsx - شاشة الفواتير
import { NextPage } from 'next';
import { DashboardLayout } from '../../components/layouts/DashboardLayout';
import { InvoiceManager } from '../../components/invoices/InvoiceManager';

const InvoicesPage: NextPage = () => {
  return (
    <DashboardLayout title="Rechnungen">
      <InvoiceManager />
    </DashboardLayout>
  );
};

export default InvoicesPage;

// src/pages/dashboard/templates.tsx - شاشة القوالب
import { NextPage } from 'next';
import { DashboardLayout } from '../../components/layouts/DashboardLayout';
import { TemplateManager } from '../../components/templates/TemplateManager';

const TemplatesPage: NextPage = () => {
  return (
    <DashboardLayout title="Vorlagen">
      <TemplateManager />
    </DashboardLayout>
  );
};

export default TemplatesPage;

// src/pages/dashboard/settings.tsx - شاشة الإعدادات
import { NextPage } from 'next';
import { DashboardLayout } from '../../components/layouts/DashboardLayout';
import { SettingsManager } from '../../components/settings/SettingsManager';

const SettingsPage: NextPage = () => {
  return (
    <DashboardLayout title="Einstellungen">
      <SettingsManager />
    </DashboardLayout>
  );
};

export default SettingsPage;
```

### مكونات التخطيط والتنقل

```typescript
// src/components/layouts/DashboardLayout.tsx
import React from 'react';
import { Sidebar } from '../navigation/Sidebar';
import { Header } from '../navigation/Header';

interface DashboardLayoutProps {
  title: string;
  children: React.ReactNode;
}

export const DashboardLayout: React.FC<DashboardLayoutProps> = ({ title, children }) => {
  return (
    <div className="min-h-screen bg-gray-50">
      <Sidebar />
      <div className="lg:pl-64">
        <Header title={title} />
        <main className="py-6">
          <div className="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
            {children}
          </div>
        </main>
      </div>
    </div>
  );
};

// src/components/navigation/Sidebar.tsx
import React from 'react';
import Link from 'next/link';
import { useRouter } from 'next/router';
import { 
  HomeIcon, 
  DocumentArrowUpIcon, 
  UsersIcon, 
  ShoppingBagIcon, 
  DocumentTextIcon, 
  DocumentDuplicateIcon, 
  CogIcon 
} from '@heroicons/react/24/outline';

const navigation = [
  { name: 'Dashboard', href: '/dashboard', icon: HomeIcon },
  { name: 'CSV-Uploads', href: '/dashboard/uploads', icon: DocumentArrowUpIcon },
  { name: 'Kunden', href: '/dashboard/customers', icon: UsersIcon },
  { name: 'Aufträge', href: '/dashboard/orders', icon: ShoppingBagIcon },
  { name: 'Rechnungen', href: '/dashboard/invoices', icon: DocumentTextIcon },
  { name: 'Vorlagen', href: '/dashboard/templates', icon: DocumentDuplicateIcon },
  { name: 'Einstellungen', href: '/dashboard/settings', icon: CogIcon },
];

export const Sidebar: React.FC = () => {
  const router = useRouter();

  return (
    <div className="hidden lg:fixed lg:inset-y-0 lg:z-50 lg:flex lg:w-64 lg:flex-col">
      <div className="flex grow flex-col gap-y-5 overflow-y-auto bg-white px-6 pb-4 shadow-sm">
        <div className="flex h-16 shrink-0 items-center">
          <h1 className="text-xl font-bold text-gray-900">Rechnungs-App</h1>
        </div>
        <nav className="flex flex-1 flex-col">
          <ul role="list" className="flex flex-1 flex-col gap-y-7">
            <li>
              <ul role="list" className="-mx-2 space-y-1">
                {navigation.map((item) => {
                  const isActive = router.pathname === item.href;
                  return (
                    <li key={item.name}>
                      <Link
                        href={item.href}
                        className={`group flex gap-x-3 rounded-md p-2 text-sm leading-6 font-semibold ${
                          isActive
                            ? 'bg-blue-50 text-blue-600'
                            : 'text-gray-700 hover:text-blue-600 hover:bg-gray-50'
                        }`}
                      >
                        <item.icon
                          className={`h-6 w-6 shrink-0 ${
                            isActive ? 'text-blue-600' : 'text-gray-400 group-hover:text-blue-600'
                          }`}
                          aria-hidden="true"
                        />
                        {item.name}
                      </Link>
                    </li>
                  );
                })}
              </ul>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  );
};

// src/components/navigation/Header.tsx
import React from 'react';
import { UserMenu } from './UserMenu';

interface HeaderProps {
  title: string;
}

export const Header: React.FC<HeaderProps> = ({ title }) => {
  return (
    <div className="sticky top-0 z-40 flex h-16 shrink-0 items-center gap-x-4 border-b border-gray-200 bg-white px-4 shadow-sm sm:gap-x-6 sm:px-6 lg:px-8">
      <div className="flex flex-1 gap-x-4 self-stretch lg:gap-x-6">
        <div className="flex items-center">
          <h1 className="text-xl font-semibold text-gray-900">{title}</h1>
        </div>
        <div className="flex flex-1 justify-end">
          <UserMenu />
        </div>
      </div>
    </div>
  );
};
```

## لوحة تحكم المسؤول (Admin Dashboard)

تهدف لوحة تحكم المسؤول إلى توفير رؤية شاملة ومراقبة دقيقة لجميع جوانب النظام. تركز هذه اللوحة على الإدارة، المراقبة، والتحكم في النظام على مستوى أعلى من لوحة تحكم المستخدم العادي.

### الشاشات الرئيسية للمسؤول

#### 1. شاشة إدارة المستخدمين (Benutzerverwaltung)

تمكن المسؤولين من إدارة جميع المستخدمين في النظام:

*   **قائمة المستخدمين (Benutzerliste):** جدول شامل يعرض جميع المستخدمين مع معلومات مثل الاسم، البريد الإلكتروني، الدور، المنظمة، تاريخ آخر تسجيل دخول، والحالة (نشط/غير نشط).
*   **إضافة مستخدم جديد (Neuen Benutzer hinzufügen):** نموذج لإنشاء حسابات مستخدمين جديدة مع تعيين الأدوار والأذونات.
*   **تحرير بيانات المستخدم (Benutzerdaten bearbeiten):** تحديث معلومات المستخدمين، تغيير الأدوار، أو تعطيل الحسابات.
*   **سجل نشاط المستخدم (Benutzeraktivität):** عرض سجل تفصيلي لأنشطة كل مستخدم داخل النظام.

#### 2. شاشة الأدوار والأذونات (Rollen & Rechte)

نظام إدارة الأدوار والأذونات المبني على RBAC (Role-Based Access Control):

*   **قائمة الأدوار (Rollenliste):** عرض جميع الأدوار المحددة في النظام (مثل Admin, User, Manager).
*   **إنشاء دور جديد (Neue Rolle erstellen):** إمكانية إنشاء أدوار مخصصة مع أذونات محددة.
*   **تحرير الأذونات (Berechtigungen bearbeiten):** تحديد الأذونات لكل دور (مثل قراءة الفواتير، إنشاء الفواتير، حذف العملاء، إلخ).
*   **تعيين الأدوار للمستخدمين (Rollen zuweisen):** ربط المستخدمين بالأدوار المناسبة.

#### 3. شاشة نظرة عامة على المنظمات (Organisationsübersicht)

في حالة دعم النظام لعدة مستأجرين (multi-tenancy):

*   **قائمة المنظمات (Organisationsliste):** عرض جميع المنظمات المسجلة مع معلومات مثل الاسم، عدد المستخدمين، عدد الفواتير، والحالة.
*   **إضافة منظمة جديدة (Neue Organisation hinzufügen):** إنشاء منظمات جديدة مع تكوين الإعدادات الأساسية.
*   **إحصائيات المنظمة (Organisationsstatistiken):** عرض مقاييس مفصلة لكل منظمة مثل عدد الفواتير الشهرية، الإيرادات، ومعدل النمو.

#### 4. شاشة مقاييس النظام (Systemmetriken)

لوحة مراقبة شاملة لأداء النظام:

*   **مقاييس الأداء (Leistungsmetriken):** عرض مقاييس مثل وقت الاستجابة، استخدام الذاكرة، استخدام وحدة المعالجة المركزية، وحالة قاعدة البيانات.
*   **إحصائيات الاستخدام (Nutzungsstatistiken):** عدد المستخدمين النشطين، عدد الفواتير المنشأة يوميًا/شهريًا، وحجم البيانات المعالجة.
*   **مراقبة الأخطاء (Fehlerüberwachung):** عرض الأخطاء الحديثة، معدل الأخطاء، والمشاكل الحرجة التي تتطلب انتباهًا فوريًا.
*   **حالة الخدمات (Service-Status):** مراقبة حالة الخدمات المختلفة مثل قاعدة البيانات، تخزين الملفات، قائمة الانتظار، وتكامل Shopify.

#### 5. شاشة سجل التدقيق (Audit-Log)

سجل شامل لجميع الأنشطة الهامة في النظام:

*   **سجل الأنشطة (Aktivitätsprotokoll):** عرض زمني لجميع الإجراءات المهمة مثل إنشاء الفواتير، تحديث بيانات العملاء، تسجيل الدخول، وتغييرات الإعدادات.
*   **تصفية وبحث متقدم (Erweiterte Filterung):** إمكانية التصفية حسب المستخدم، نوع النشاط، التاريخ، أو المنظمة.
*   **تصدير السجلات (Protokolle exportieren):** إمكانية تصدير سجلات التدقيق لأغراض الامتثال أو التحليل.
*   **تنبيهات الأمان (Sicherheitswarnungen):** تنبيهات تلقائية للأنشطة المشبوهة أو غير المعتادة.

#### 6. شاشة إعدادات الميزات (Feature-Flags)

إدارة الميزات والتحكم في إتاحتها:

*   **قائمة الميزات (Feature-Liste):** عرض جميع الميزات القابلة للتحكم مع حالتها الحالية (مفعلة/معطلة).
*   **تفعيل/تعطيل الميزات (Features aktivieren/deaktivieren):** إمكانية تشغيل أو إيقاف ميزات معينة للنظام بأكمله أو لمنظمات محددة.
*   **اختبار A/B (A/B-Tests):** إعداد اختبارات A/B لميزات جديدة مع مجموعات مستخدمين محددة.
*   **جدولة الميزات (Feature-Scheduling):** جدولة تفعيل أو تعطيل ميزات في أوقات محددة.

### هيكل صفحات React/Next.js للمسؤول

```typescript
// src/pages/admin/index.tsx - الصفحة الرئيسية للوحة تحكم المسؤول
import { NextPage } from 'next';
import { AdminLayout } from '../../components/layouts/AdminLayout';
import { AdminOverview } from '../../components/admin/AdminOverview';

const AdminDashboard: NextPage = () => {
  return (
    <AdminLayout title="Admin Dashboard">
      <AdminOverview />
    </AdminLayout>
  );
};

export default AdminDashboard;

// src/pages/admin/users.tsx - شاشة إدارة المستخدمين
import { NextPage } from 'next';
import { AdminLayout } from '../../components/layouts/AdminLayout';
import { UserManagement } from '../../components/admin/UserManagement';

const UsersPage: NextPage = () => {
  return (
    <AdminLayout title="Benutzerverwaltung">
      <UserManagement />
    </AdminLayout>
  );
};

export default UsersPage;

// src/pages/admin/roles.tsx - شاشة الأدوار والأذونات
import { NextPage } from 'next';
import { AdminLayout } from '../../components/layouts/AdminLayout';
import { RoleManagement } from '../../components/admin/RoleManagement';

const RolesPage: NextPage = () => {
  return (
    <AdminLayout title="Rollen & Rechte">
      <RoleManagement />
    </AdminLayout>
  );
};

export default RolesPage;

// src/pages/admin/organizations.tsx - شاشة نظرة عامة على المنظمات
import { NextPage } from 'next';
import { AdminLayout } from '../../components/layouts/AdminLayout';
import { OrganizationOverview } from '../../components/admin/OrganizationOverview';

const OrganizationsPage: NextPage = () => {
  return (
    <AdminLayout title="Organisationsübersicht">
      <OrganizationOverview />
    </AdminLayout>
  );
};

export default OrganizationsPage;

// src/pages/admin/metrics.tsx - شاشة مقاييس النظام
import { NextPage } from 'next';
import { AdminLayout } from '../../components/layouts/AdminLayout';
import { SystemMetrics } from '../../components/admin/SystemMetrics';

const MetricsPage: NextPage = () => {
  return (
    <AdminLayout title="Systemmetriken">
      <SystemMetrics />
    </AdminLayout>
  );
};

export default MetricsPage;

// src/pages/admin/audit.tsx - شاشة سجل التدقيق
import { NextPage } from 'next';
import { AdminLayout } from '../../components/layouts/AdminLayout';
import { AuditLog } from '../../components/admin/AuditLog';

const AuditPage: NextPage = () => {
  return (
    <AdminLayout title="Audit-Log">
      <AuditLog />
    </AdminLayout>
  );
};

export default AuditPage;

// src/pages/admin/features.tsx - شاشة إعدادات الميزات
import { NextPage } from 'next';
import { AdminLayout } from '../../components/layouts/AdminLayout';
import { FeatureFlags } from '../../components/admin/FeatureFlags';

const FeaturesPage: NextPage = () => {
  return (
    <AdminLayout title="Feature-Flags">
      <FeatureFlags />
    </AdminLayout>
  );
};

export default FeaturesPage;
```

## حراس المسارات (Route Guards) ووسطاء RBAC

لضمان الأمان والتحكم في الوصول، سنحتاج إلى تطبيق حراس المسارات ووسطاء RBAC للتحقق من أذونات المستخدمين قبل السماح لهم بالوصول إلى صفحات أو ميزات معينة.

### حراس المسارات (Route Guards)

```typescript
// src/components/guards/AuthGuard.tsx
import React, { useEffect } from 'react';
import { useSession } from 'next-auth/react';
import { useRouter } from 'next/router';
import { LoadingSpinner } from '../ui/LoadingSpinner';

interface AuthGuardProps {
  children: React.ReactNode;
}

export const AuthGuard: React.FC<AuthGuardProps> = ({ children }) => {
  const { data: session, status } = useSession();
  const router = useRouter();

  useEffect(() => {
    if (status === 'loading') return; // Still loading

    if (!session) {
      router.push('/auth/signin');
      return;
    }
  }, [session, status, router]);

  if (status === 'loading') {
    return <LoadingSpinner />;
  }

  if (!session) {
    return null;
  }

  return <>{children}</>;
};

// src/components/guards/RoleGuard.tsx
import React from 'react';
import { useSession } from 'next-auth/react';
import { UserRole } from '@prisma/client';
import { AccessDenied } from '../ui/AccessDenied';

interface RoleGuardProps {
  allowedRoles: UserRole[];
  children: React.ReactNode;
}

export const RoleGuard: React.FC<RoleGuardProps> = ({ allowedRoles, children }) => {
  const { data: session } = useSession();

  if (!session?.user?.role || !allowedRoles.includes(session.user.role)) {
    return <AccessDenied />;
  }

  return <>{children}</>;
};

// src/components/guards/PermissionGuard.tsx
import React from 'react';
import { usePermissions } from '../../hooks/usePermissions';
import { AccessDenied } from '../ui/AccessDenied';

interface PermissionGuardProps {
  permission: string;
  children: React.ReactNode;
}

export const PermissionGuard: React.FC<PermissionGuardProps> = ({ permission, children }) => {
  const { hasPermission, loading } = usePermissions();

  if (loading) {
    return <div>Berechtigungen werden überprüft...</div>;
  }

  if (!hasPermission(permission)) {
    return <AccessDenied />;
  }

  return <>{children}</>;
};
```

### وسطاء RBAC (RBAC Middleware)

```typescript
// src/middleware/rbac.ts
import { NextApiRequest, NextApiResponse } from 'next';
import { getServerSession } from 'next-auth/next';
import { authOptions } from '../pages/api/auth/[...nextauth]';
import { PrismaClient, UserRole } from '@prisma/client';

const prisma = new PrismaClient();

export interface AuthenticatedRequest extends NextApiRequest {
  user: {
    id: string;
    email: string;
    role: UserRole;
    organizationId?: string;
  };
}

export function withAuth(handler: (req: AuthenticatedRequest, res: NextApiResponse) => Promise<void>) {
  return async (req: NextApiRequest, res: NextApiResponse) => {
    const session = await getServerSession(req, res, authOptions);

    if (!session?.user?.email) {
      return res.status(401).json({ error: 'Nicht authentifiziert' });
    }

    const user = await prisma.user.findUnique({
      where: { email: session.user.email },
      select: { id: true, email: true, role: true, organizationId: true },
    });

    if (!user) {
      return res.status(401).json({ error: 'Benutzer nicht gefunden' });
    }

    (req as AuthenticatedRequest).user = user;
    return handler(req as AuthenticatedRequest, res);
  };
}

export function withRole(allowedRoles: UserRole[]) {
  return function (handler: (req: AuthenticatedRequest, res: NextApiResponse) => Promise<void>) {
    return withAuth(async (req: AuthenticatedRequest, res: NextApiResponse) => {
      if (!allowedRoles.includes(req.user.role)) {
        return res.status(403).json({ error: 'Unzureichende Berechtigung' });
      }

      return handler(req, res);
    });
  };
}

export function withPermission(permission: string) {
  return function (handler: (req: AuthenticatedRequest, res: NextApiResponse) => Promise<void>) {
    return withAuth(async (req: AuthenticatedRequest, res: NextApiResponse) => {
      // هنا يمكنك تطبيق منطق التحقق من الأذونات المفصلة
      // بناءً على نظام الأذونات الذي تختاره
      const hasPermission = await checkUserPermission(req.user.id, permission);

      if (!hasPermission) {
        return res.status(403).json({ error: 'Fehlende Berechtigung für diese Aktion' });
      }

      return handler(req, res);
    });
  };
}

async function checkUserPermission(userId: string, permission: string): Promise<boolean> {
  // تطبيق منطق التحقق من الأذونات
  // يمكن أن يكون هذا بناءً على جدول أذونات منفصل أو منطق مخصص
  // لأغراض هذا المثال، سنفترض أن المسؤولين لديهم جميع الأذونات
  const user = await prisma.user.findUnique({
    where: { id: userId },
    select: { role: true },
  });

  if (user?.role === 'ADMIN') {
    return true;
  }

  // يمكنك إضافة منطق أكثر تعقيدًا هنا للتحقق من أذونات محددة
  return false;
}
```

### أمثلة على فحوصات السياسة (Policy Checks)

```typescript
// src/utils/policies.ts
import { User, UserRole } from '@prisma/client';

export class PolicyChecker {
  static canViewInvoices(user: User): boolean {
    return user.role === 'ADMIN' || user.role === 'USER';
  }

  static canCreateInvoices(user: User): boolean {
    return user.role === 'ADMIN' || user.role === 'USER';
  }

  static canDeleteInvoices(user: User): boolean {
    return user.role === 'ADMIN';
  }

  static canManageUsers(user: User): boolean {
    return user.role === 'ADMIN';
  }

  static canViewAuditLogs(user: User): boolean {
    return user.role === 'ADMIN';
  }

  static canAccessAdminDashboard(user: User): boolean {
    return user.role === 'ADMIN';
  }

  static canModifyOrganizationSettings(user: User, organizationId: string): boolean {
    return user.role === 'ADMIN' || 
           (user.role === 'USER' && user.organizationId === organizationId);
  }

  static canViewCustomerData(user: User, customerOrganizationId: string): boolean {
    return user.role === 'ADMIN' || user.organizationId === customerOrganizationId;
  }
}

// استخدام فحوصات السياسة في المكونات
// src/components/invoices/InvoiceActions.tsx
import React from 'react';
import { useSession } from 'next-auth/react';
import { PolicyChecker } from '../../utils/policies';
import { Button } from '../ui/Button';

interface InvoiceActionsProps {
  invoiceId: string;
}

export const InvoiceActions: React.FC<InvoiceActionsProps> = ({ invoiceId }) => {
  const { data: session } = useSession();
  const user = session?.user;

  if (!user) return null;

  return (
    <div className="flex space-x-2">
      {PolicyChecker.canViewInvoices(user) && (
        <Button variant="outline">Anzeigen</Button>
      )}
      
      {PolicyChecker.canCreateInvoices(user) && (
        <Button variant="outline">Bearbeiten</Button>
      )}
      
      {PolicyChecker.canDeleteInvoices(user) && (
        <Button variant="destructive">Löschen</Button>
      )}
    </div>
  );
};
```

## مكونات التخطيط المشتركة

```typescript
// src/components/layouts/AdminLayout.tsx
import React from 'react';
import { AdminSidebar } from '../navigation/AdminSidebar';
import { Header } from '../navigation/Header';
import { AuthGuard } from '../guards/AuthGuard';
import { RoleGuard } from '../guards/RoleGuard';

interface AdminLayoutProps {
  title: string;
  children: React.ReactNode;
}

export const AdminLayout: React.FC<AdminLayoutProps> = ({ title, children }) => {
  return (
    <AuthGuard>
      <RoleGuard allowedRoles={['ADMIN']}>
        <div className="min-h-screen bg-gray-50">
          <AdminSidebar />
          <div className="lg:pl-64">
            <Header title={title} />
            <main className="py-6">
              <div className="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
                {children}
              </div>
            </main>
          </div>
        </div>
      </RoleGuard>
    </AuthGuard>
  );
};

// src/components/navigation/AdminSidebar.tsx
import React from 'react';
import Link from 'next/link';
import { useRouter } from 'next/router';
import { 
  HomeIcon, 
  UsersIcon, 
  ShieldCheckIcon, 
  BuildingOfficeIcon, 
  ChartBarIcon, 
  DocumentMagnifyingGlassIcon, 
  FlagIcon 
} from '@heroicons/react/24/outline';

const adminNavigation = [
  { name: 'Dashboard', href: '/admin', icon: HomeIcon },
  { name: 'Benutzerverwaltung', href: '/admin/users', icon: UsersIcon },
  { name: 'Rollen & Rechte', href: '/admin/roles', icon: ShieldCheckIcon },
  { name: 'Organisationen', href: '/admin/organizations', icon: BuildingOfficeIcon },
  { name: 'Systemmetriken', href: '/admin/metrics', icon: ChartBarIcon },
  { name: 'Audit-Log', href: '/admin/audit', icon: DocumentMagnifyingGlassIcon },
  { name: 'Feature-Flags', href: '/admin/features', icon: FlagIcon },
];

export const AdminSidebar: React.FC = () => {
  const router = useRouter();

  return (
    <div className="hidden lg:fixed lg:inset-y-0 lg:z-50 lg:flex lg:w-64 lg:flex-col">
      <div className="flex grow flex-col gap-y-5 overflow-y-auto bg-gray-900 px-6 pb-4">
        <div className="flex h-16 shrink-0 items-center">
          <h1 className="text-xl font-bold text-white">Admin Panel</h1>
        </div>
        <nav className="flex flex-1 flex-col">
          <ul role="list" className="flex flex-1 flex-col gap-y-7">
            <li>
              <ul role="list" className="-mx-2 space-y-1">
                {adminNavigation.map((item) => {
                  const isActive = router.pathname === item.href;
                  return (
                    <li key={item.name}>
                      <Link
                        href={item.href}
                        className={`group flex gap-x-3 rounded-md p-2 text-sm leading-6 font-semibold ${
                          isActive
                            ? 'bg-gray-800 text-white'
                            : 'text-gray-400 hover:text-white hover:bg-gray-800'
                        }`}
                      >
                        <item.icon
                          className="h-6 w-6 shrink-0"
                          aria-hidden="true"
                        />
                        {item.name}
                      </Link>
                    </li>
                  );
                })}
              </ul>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  );
};
```

## قائمة التحقق ومعايير القبول

*   [ ] **لوحة تحكم المستخدم:** تم تصميم وتطوير جميع الشاشات الست الرئيسية (التحميلات، العملاء، الطلبات، الفواتير، القوالب، الإعدادات).
*   [ ] **لوحة تحكم المسؤول:** تم تصميم وتطوير جميع الشاشات الست الرئيسية (إدارة المستخدمين، الأدوار والأذونات، نظرة عامة على المنظمات، مقاييس النظام، سجل التدقيق، إعدادات الميزات).
*   [ ] **واجهة المستخدم باللغة الألمانية:** جميع النصوص، التسميات، والرسائل باللغة الألمانية.
*   [ ] **هيكل صفحات Next.js:** تم إنشاء هيكل صفحات منظم ومنطقي لكل من لوحات تحكم المستخدم والمسؤول.
*   [ ] **مكونات التخطيط والتنقل:** تم تطوير مكونات قابلة لإعادة الاستخدام للتخطيط، الشريط الجانبي، والرأس.
*   [ ] **حراس المسارات:** تم تطبيق حراس المسارات للتحقق من المصادقة والأذونات.
*   [ ] **وسطاء RBAC:** تم تطوير وسطاء للتحكم في الوصول بناءً على الأدوار والأذونات.
*   [ ] **فحوصات السياسة:** تم تطبيق فحوصات السياسة لتحديد ما يمكن للمستخدمين فعله بناءً على أدوارهم.
*   [ ] **تصميم متجاوب:** جميع الشاشات متجاوبة وتعمل بشكل جيد على الأجهزة المختلفة.
*   [ ] **إمكانية الوصول:** تم تطبيق معايير إمكانية الوصول الأساسية (WCAG 2.1 AA).

بهذا نكون قد أكملنا تصميم وتطوير لوحات تحكم شاملة ومتقدمة لكل من المستخدمين والمسؤولين، مع التركيز على الأمان، سهولة الاستخدام، والامتثال للمتطلبات.

